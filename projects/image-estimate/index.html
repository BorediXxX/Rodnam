<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>image estimate</title>
</head>
<body>

	<style>
		#canvas { 
			position:absolute;
			top:50%;
			left:50%;
			transform:translate(-50%,-50%);
			border:1px solid #000;
		}	
	</style>

	<input type="file" id="image-ipt"><br><br>
	<button id="render">Render</button>
	<canvas id="canvas"></canvas>
	<script>

		const canvas = document.getElementById("canvas");
		const ctx = canvas.getContext("2d");

		var c_height = 500;
		var c_width = 500;

		canvas.height = c_height;
		canvas.width = c_width * 2;

		let colors = [];
		let sim_min = 0.6;

		let imageData_og;
		let imageData_old;
		let imageData_new;
		
		let ready = false;
		let margin = 0;

		function getColors() {
			imageData_og = ctx.getImageData(0,0,c_height,c_width);
			for (let i = 0;i<imageData_og.data.length;i+=4) {
				let r = imageData_og.data[i];
				let g = imageData_og.data[i + 1];
				let b = imageData_og.data[i + 2];
				colors.push([r,g,b]);
			}
			return;
		}

		function renderOriginal(image) {
			ctx.clearRect(0,0,c_height,c_width);
			ctx.drawImage(image, 0,0);
			ctx.clearRect(c_width,0,c_width,c_height);
		}

		const file_input = document.getElementById("image-ipt"); 
		file_input.addEventListener('change', event => {
			if (event.target.files[0]) {
				const file = event.target.files[0];
				const reader = new FileReader();
				reader.onload = event => {
					const image = new Image();
					image.src = event.target.result;
					image.onload = () => {
						renderOriginal(image);
						getColors(image);
					}
				};
				reader.readAsDataURL(file);
				ready = true;
			}
		});

		const render_btn = document.getElementById("render");

		render_btn.addEventListener('click', event => {

			if (!ready) return;

			imageData_old = ctx.getImageData(c_width, 0, c_width, c_height);

			while (margin < 0.4) {

				let colorIndex = Math.floor(Math.random() * colors.length);
				let color = colors[colorIndex];

				let blotchX = c_width + 50 + Math.floor(Math.random() * c_width);
				let blotchY = Math.floor(Math.random() * c_height);


				ctx.beginPath();
				ctx.arc(blotchX, blotchY, 50, 0, 2 * Math.PI);

				let color_s = "rgb(" + color.join(',') + ")";

				ctx.fillStyle = color_s;
				ctx.fill();

				imageData_new = ctx.getImageData(c_width, 0, c_width, c_height);

				let total = 0;
				let amt_same = 0;

				for (let i = 0;i<imageData_new.data.length;i+=4) {

					let og_r = imageData_og.data[i];
					let og_g = imageData_og.data[i + 1];
					let og_b = imageData_og.data[i + 2];

					let new_r = imageData_new.data[i];
					let new_g = imageData_new.data[i + 1];
					let new_b = imageData_new.data[i + 2];

					if (og_r == new_r && og_g == new_g && og_b == new_b) {
						amt_same += 1;
					}
					total += 1;

				}

				let new_margin = amt_same / total;
				if (new_margin > margin) {
					console.log(margin);
					margin = new_margin;
					imageData_old = imageData_new;
				}
				
				ctx.putImageData(imageData_old, c_width, 0);
			}
			console.log("done");
		});

	</script>

</body>
</html>