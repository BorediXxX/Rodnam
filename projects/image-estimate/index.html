<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>image estimate</title>
</head>
<body>

	<style>
		body {
			color:#fff;
			background:#14284A;
		}
		#canvas { 
			position:absolute;
			top:50%;
			left:50%;
			transform:translate(-50%,-50%);
			border:1px solid #fff;
		}	
	</style>

	<input type="file" id="image-ipt"><br><br>
	<button id="render">Render</button>
	<button id="stop">Stop</button>
	<canvas id="canvas"></canvas>
	<p id="percent"></p>
	<script src="lodash.core.js"></script>
	<script>

		const canvas = document.getElementById("canvas");
		const ctx = canvas.getContext("2d");

		var c_height = 500;
		var c_width = 500;

		canvas.height = c_height;
		canvas.width = c_width * 2;

		let colors = [];
		let sim_min = 0.9;
		let radius = 30;

		let imageData_og;
		let imageData_old;
		let imageData_new;
		
		let ready = false;
		let margin = 0;

		function renderOriginal(image) {
			ctx.clearRect(0,0,c_height,c_width);
			ctx.drawImage(image, 0,0);
			ctx.clearRect(c_width,0,c_width,c_height);
		}

		function nextFrame() {

				const startTime = new Date().getTime();

				while (new Date().getTime() - startTime < 1000 / 30) {

					let colorIndex = Math.floor(Math.random() * (imageData_og.data.length / 4)) * 4;
					let color = [imageData_og.data[colorIndex], imageData_og.data[colorIndex + 1], imageData_og.data[colorIndex + 2]];

					const radius = Math.random() * 30;

					let blotchX = c_width + radius + Math.floor(Math.random() * c_width);
					let blotchY = Math.floor(Math.random() * c_height);

					ctx.beginPath();
					ctx.arc(blotchX, blotchY, radius, 0, 2 * Math.PI);

					let color_s = "rgb(" + color.join(',') + ")";

					ctx.fillStyle = color_s;
					ctx.fill();

					imageData_new = ctx.getImageData(c_width, 0, c_width, c_height);

					let total = 0;
					let amt_same = 0;
					
					for (let i = 0;i<imageData_new.data.length;i+=4) {
						total += 1;
						let og_r = imageData_og.data[i];
						let og_g = imageData_og.data[i + 1];
						let og_b = imageData_og.data[i + 2];

						let new_r = imageData_new.data[i];
						let new_g = imageData_new.data[i + 1];
						let new_b = imageData_new.data[i + 2];

						amt_same += 1 - Math.pow(Math.pow((new_r - og_r), 2) + Math.pow((new_g - og_g), 2) + Math.pow((new_b - og_b), 2), 1/3)/57.99633349791179; 
						
					}
					

					let new_margin = amt_same / total;

					if (new_margin > margin) {
						margin = new_margin;
						console.info(margin);
						const p = document.getElementById("percent");
						p.innerText = margin * 100 + "%";
						imageData_old = imageData_new;
					}
					ctx.putImageData(imageData_old, c_width, 0);
				}
				if (ready) requestAnimationFrame(nextFrame);
		}

		function render(){
			if (!ready) return;
			nextFrame();
		}

		const file_input = document.getElementById("image-ipt"); 
		file_input.addEventListener('change', event => {
			if (event.target.files[0]) {
				const file = event.target.files[0];
				const reader = new FileReader();
				reader.onload = event => {
					const image = new Image();
					image.src = event.target.result;
					image.onload = () => {
						renderOriginal(image);
						imageData_og = ctx.getImageData(0,0,c_height,c_width);
					}
				};
				reader.readAsDataURL(file);
				ready = true;
			}
		});

		const stop_btn = document.getElementById("stop");
		stop_btn.addEventListener('click', event => {
			ready = false;
		});

		const render_btn = document.getElementById("render");
		render_btn.addEventListener('click', event => {

			if (!ready) return;

			imageData_old = ctx.getImageData(c_width, 0, c_width, c_height);
			ctx.fillStyle = "#000000";
			ctx.fillRect(c_width,0,c_width, c_height);
			render();
			return;
			
		});

	</script>

</body>
</html>